rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // DEVELOPMENT MODE: Allow unauthenticated access for test OTP flow
    // NOTE: In production, you should require authentication
    // For now, we allow all operations to support manual auth (test OTP) users
    
    // Users collection - allow reads for contact search
    match /users/{userId} {
      // Allow read for everyone (needed for contact search and manual auth)
      allow read: if true;
      
      // Allow create if phoneNumber is provided
      allow create: if request.resource.data.phoneNumber != null;
      
      // Allow update (users can update their own data)
      allow update: if true;
      
      // Allow delete
      allow delete: if true;
    }
    
    // Chat rooms collection
    match /chatRooms/{chatRoomId} {
      // Allow read for everyone
      allow read: if true;
      
      // Allow create if participants array is valid
      allow create: if request.resource.data.participants is list &&
        request.resource.data.participants.size() > 0;
      
      // Allow update
      allow update: if true;
      
      // Allow delete (for delete chat functionality)
      allow delete: if true;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Allow read for everyone
        allow read: if true;
        
        // Allow create if senderId is set
        allow create: if request.resource.data.senderId != null;
        
        // Allow update (for read receipts)
        allow update: if true;
        
        // Allow delete (for delete chat functionality)
        allow delete: if true;
      }
    }
  }
}
